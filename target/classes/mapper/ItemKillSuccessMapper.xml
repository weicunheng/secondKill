<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.weiheng.secondkill.kill.mapper.ItemKillSuccessMapper">
    <select id="countByKillAndUid" resultType="Integer">
        select count(1)
        from item_kill_success
        where item_id = #{killId}
          and user_id = #{userId};
    </select>

    <insert id="insertKillSuccess">
        insert into item_kill_success(code, item_id, kill_id, user_id, status, create_time)
        values (#{code}, #{itemId}, #{killId}, #{userId}, #{status}, #{createTime})
    </insert>

    <select id="selectKillSuccessInfo" resultType="com.weiheng.secondkill.kill.domain.KillSuccessUserInfo">
        SELECT
            b.user_name AS username,
            b.phone AS phone,
            b.email AS email,
            c.NAME AS goodsName,
            a.code as code,
            a.status as status,
            a.create_time as createTime
        FROM
            item_kill_success AS a
                LEFT JOIN user AS b ON a.user_id = b.id
                LEFT JOIN item c ON a.item_id = c.id
        WHERE
            a.CODE = #{orderNo};
    </select>

    <update id="expireOrder">
        update item_kill_success set status = -1 where code=#{orderNo} and status=0;
    </update>

    <select id="selectExpireOrders" resultType="com.weiheng.secondkill.entity.ItemKillSuccess">
        SELECT
            * , TIMESTAMPDIFF(MINUTE, a.create_time, NOW()) as diffTime
        FROM
            item_kill_success  as a
        WHERE
            STATUS = 0;
    </select>

    <select id="selectOneV2" resultType="com.weiheng.secondkill.entity.ItemKill"></select>

</mapper>